"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const e=require("./common/vendor.js"),n=require("./utils/business.js"),o=require("./utils/share.js");Math;const t={onLaunch:async function(){n.initUserInfo.call(this),console.warn("当前组件仅支持 uni_modules 目录结构 ，请升级 HBuilderX 到 3.1.0 版本以上 123123！"),console.log("App Launch")},onShow:function(){this.refreshToken(),console.log("App Show")},onHide:function(){console.log("App Hide")},methods:{userDefaultLogin:()=>{e.index.login({async success(n){const o=e.Ds.importObject("uni-id-co"),t=await o.loginByWeixin({code:n.code});console.log("logined:",t)}})},refreshToken(){const n=e.index.getStorageSync("uni_id_token_expired")||0,o=e.index.getStorageSync("token"),t=n-Date.now()<36e3;console.log("tokenIsExpired:",t);const i=e.Ds.importObject("uni-id-co");t&&o&&i.refreshToken().then((n=>{console.log("刷新token:",n);const{newToken:{token:o,tokenExpired:t}}=n;e.index.setStorageSync("token",o),e.index.setStorageSync("uni_id_token",o),e.index.setStorageSync("uni_id_token_expired",t)}),(n=>{console.log("刷新失败：",n),e.index.removeStorageSync("token"),e.index.reLaunch({url:"/pages/index/index"})})),console.log("tokenIsExpired:",t)}},globalData:{userInfo:{avatar:"https://mmbiz.qpic.cn/mmbiz/icTdbqWNOwNRna42FI242Lcia07jQodd2FJGIYQfG0LAJGFxM4FbnQP6yfMxBgJ0F3YRqJCJ1aPAK2dQagdusBZg/0",nickname:"小白"},hasUserInfo:!1,apiDomain:"http://127.0.0.1:8000/api",txAPIToken:"TOMTWTRw2ZiZ0W",txAPITokenSecret:"c10181f23359f4139a479723f04eb502",downloadPrefix:"http://127.0.0.1:8000/download?url=",defaultDailyFreeParseNum:30,getUserInfo:function(n=null){e.index.login({success:o=>{var t=o.code;e.index.getSetting({success:o=>{o.authSetting["scope.userInfo"]&&e.index.getUserInfo({success:o=>{this.checkIsLogin()||this.getToken(t,o.encryptedData,o.inviteCode).then((o=>{n&&(e.index.hideLoading(),n({code:200,data:o}))}))}})}})},complete(){e.index.hideLoading()}})},apiRequest:function(n){const o=n.fullUrl?n.fullUrl:this.apiDomain+n.url;e.index.request({url:o,method:n.method?n.method:"GET",header:{Authorization:"Bearer "+e.index.getStorageSync("token"),Accept:"application/json"},dataType:"json",data:n.data,success:o=>{switch(o.statusCode){case 200:n.success(o);break;case 401:this.toLogin();break;case 422:break;case 404:e.index.showToast({title:"请求地址不存在",icon:"none"});break;default:e.index.showToast({title:"出错了～请稍后再试",icon:"none"})}},fail:e=>{n.fail&&n.fail(e)},complete:e=>{n.complete&&n.complete(e)}})},checkIsLogin(n=!1){return""!=e.index.getStorageSync("token")||!!n&&void this.toLogin()},toLogin(){this.hasUserInfo=!1,this.userInfo=null,e.index.removeStorageSync("token"),e.index.showToast({title:"请先登录!",icon:"none",success:n=>{e.index.switchTab({url:"/pages/mine/mine"})}})},async getToken(o,t,i,s=null){this.userInfo;const c=e.Ds.importObject("uni-id-co");try{const t=await c.loginByWeixin({code:o,inviteCode:i}),{token:s}=t.newToken;console.log("this-getToken:",this);const a=await n.initUserInfo.call(this,s);return console.log("tempFiles:",a),e.index.showToast({title:"登录成功！",icon:"success",success:n=>{e.index.setStorageSync("token",s)}}),a}catch(a){console.log("error:",a)}}}};function i(){const n=e.createSSRApp(t);return n.mixin(o.share),{app:n}}i().app.mount("#app"),exports.createApp=i;
