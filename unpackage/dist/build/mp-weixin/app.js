"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const e=require("./common/vendor.js"),o=require("./utils/business.js"),n=require("./utils/share.js");Math;const t={onLaunch:async function(){o.initUserInfo.call(this),console.warn("当前组件仅支持 uni_modules 目录结构 ，请升级 HBuilderX 到 3.1.0 版本以上 123123！"),console.log("App Launch")},onShow:function(){this.refreshToken(),console.log("App Show")},onHide:function(){console.log("App Hide")},methods:{userDefaultLogin:()=>{e.index.login({async success(o){const n=e.Bs.importObject("uni-id-co"),t=await n.loginByWeixin({code:o.code});console.log("logined:",t)}})},refreshToken(){const o=e.index.getStorageSync("uni_id_token_expired")||0,n=e.index.getStorageSync("token"),t=o-Date.now()<36e3;console.log("tokenIsExpired:",t);const i=e.Bs.importObject("uni-id-co");t&&n&&i.refreshToken().then((o=>{console.log("刷新token:",o);const{newToken:{token:n,tokenExpired:t}}=o;e.index.setStorageSync("token",n),e.index.setStorageSync("uni_id_token",n),e.index.setStorageSync("uni_id_token_expired",t)}),(o=>{console.log("刷新失败：",o),e.index.removeStorageSync("token"),e.index.reLaunch({url:"/pages/index/index"})})),console.log("tokenIsExpired:",t)}},globalData:{userInfo:{avatar:"https://mmbiz.qpic.cn/mmbiz/icTdbqWNOwNRna42FI242Lcia07jQodd2FJGIYQfG0LAJGFxM4FbnQP6yfMxBgJ0F3YRqJCJ1aPAK2dQagdusBZg/0",nickname:"小白"},hasUserInfo:!1,apiDomain:"http://127.0.0.1:8000/api",txAPIToken:"TOMTWTRw2ZiZ0W",txAPITokenSecret:"c10181f23359f4139a479723f04eb502",downloadPrefix:"http://127.0.0.1:8000/download?url=",defaultDailyFreeParseNum:30,getUserInfo:function(o=null){e.index.login({success:n=>{var t=n.code;e.index.getSetting({success:n=>{n.authSetting["scope.userInfo"]&&e.index.getUserInfo({success:n=>{console.log("getUserInfo:",n),this.checkIsLogin()||this.getToken(t,n.encryptedData,n.inviteCode).then((n=>{o&&(e.index.hideLoading(),console.log("发送给后台解码出 unionId:",n),o({code:200,data:n}))}))}})}})},complete(){e.index.hideLoading()}})},apiRequest:function(o){let n=o.url;n.startsWith("http")||(n=this.apiDomain+n),e.index.request({url:n,method:o.method?o.method:"GET",header:{Authorization:"Bearer "+e.index.getStorageSync("token"),Accept:"application/json"},dataType:"json",data:o.noToken?o.data:Object.assign({token:e.index.getStorageSync("token")},o.data),success:n=>{switch(n.statusCode){case 200:o.success(n.data);break;case 401:this.toLogin();break;case 422:break;case 404:e.index.showToast({title:"请求地址不存在",icon:"none"});break;default:e.index.showToast({title:"出错了～请稍后再试",icon:"none"})}},fail:e=>{o.fail&&o.fail(e)},complete:e=>{o.complete&&o.complete(e)}})},checkIsLogin(o=!1){return""!=e.index.getStorageSync("token")||!!o&&void this.toLogin()},toLogin(){this.hasUserInfo=!1,this.userInfo=null,e.index.removeStorageSync("token"),e.index.showToast({title:"请先登录!",icon:"none",success:o=>{e.index.switchTab({url:"/pages/mine/mine"})}})},async getToken(n,t,i,s=null){this.userInfo,console.log("this.userInfo:",this.userInfo);const c=e.Bs.importObject("uni-id-co");console.log("code:",n),console.log("inviteCode:",i);try{const t=await c.loginByWeixin({code:n,inviteCode:i}),{token:s}=t.newToken;console.log("this-getToken:",s);const a=await o.initUserInfo.call(this,s);return console.log("tempFiles:",a),e.index.showToast({title:"登录成功！",icon:"success",success:o=>{e.index.setStorageSync("token",s)}}),a}catch(a){console.log("error:",a)}}}};function i(){const o=e.createSSRApp(t);return o.mixin(n.share),{app:o}}i().app.mount("#app"),exports.createApp=i;
